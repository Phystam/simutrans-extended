#include "../simworld.h"
#include "../simintr.h"
#include "../simhalt.h"
#include "../simline.h"
#include "../dataobj/schedule.h"
#include "../display/viewport.h"
#include "../dataobj/translator.h"
#include "times_history.h"

#include "diagram_visualizer.h"
#define LINE_NAME_COLUMN_WIDTH ((D_BUTTON_WIDTH*3)+11+4)
#define SCL_HEIGHT (15*LINESPACE)
#define L_BUTTON_WIDTH (button_size.w)
#include <iostream>
/*
	This class is made by Phystam
*/

diagram_visualizer_t::diagram_visualizer_t(linehandle_t line_) :
	gui_frame_t(NULL, line_.is_bound() ? line_->get_owner() : 0),
	owner(line_.is_bound() ? line_->get_owner() : 0),
	line(line_),
	scrolly(&cont),
	hzoom_label("horizontal zoom"),
	vzoom_label("vertical zoom")
{
	//component position cursor and some constants from map_frame.cc
	scr_coord cursor( D_MARGIN_LEFT,D_MARGIN_TOP ); 
	const scr_coord_val zoom_label_width = display_get_char_max_width("0123456789") * 4 + display_get_char_width(':');
	const scr_size button_size(max(D_BUTTON_WIDTH, 100), D_BUTTON_HEIGHT);

	const scr_size size = diagram.get_size();
	const scr_size s_size=scrolly.get_size();
	const scr_size win_size = size-s_size; // this is the visible area
	diagram.set_line(line_);
	scrolly.set_scroll_position(  max(0,min(-win_size.w/2,size.w)), max(0, min(-win_size.h/2,size.h)) );
	scrolly.set_focusable(true);
	scrolly.set_scrollbar_mode(scrollbar_t::show_always);
	update_components();
	set_name(title_buf);

	diagram.set_line(line);
	// scrolly.set_focusable( true );
	// scrolly.set_scrollbar_mode(scrollbar_t::show_always);

	// diagram visualizer window
	scrolly.set_pos(scr_coord(0, 42));
	scrolly.set_show_scroll_x(true);
	// scrolly.set_color(COL_WHITE);
	add_component(&scrolly);
	set_windowsize(scr_size(D_DEFAULT_WIDTH, D_TITLEBAR_HEIGHT+4+22*(LINESPACE)+D_SCROLLBAR_HEIGHT+2));
	set_min_windowsize(scr_size(D_DEFAULT_WIDTH, D_TITLEBAR_HEIGHT+4+3*(LINESPACE)+D_SCROLLBAR_HEIGHT+2));
	set_resizemode(diagonal_resize);
	resize(scr_coord(0,42));

	//	append schedule button
	
	b_append_schedule.init(button_t::roundbox_state, "Append schedule", cursor, button_size);
	b_append_schedule.set_tooltip("Append schedule");
	b_append_schedule.set_visible(true);
	b_append_schedule.add_listener(this);
	add_component(&b_append_schedule);
	cursor.x += L_BUTTON_WIDTH+D_H_SPACE;

	b_clear_schedule.init(button_t::roundbox_state, "Clear schedule", cursor, button_size);
	b_clear_schedule.set_tooltip("Clear schedule");
	b_clear_schedule.set_visible(true);
	b_clear_schedule.add_listener(this);
	add_component(&b_clear_schedule);
	cursor = scr_coord(D_MARGIN_LEFT, cursor.y + D_BUTTON_HEIGHT + D_V_SPACE);

	// // zool label
	vzoom_label.set_pos(cursor);
	vzoom_label.set_color(SYSCOL_TEXT);
	add_component( &vzoom_label );
	cursor.x += vzoom_label.get_size().w + D_H_SPACE;

	//vertical zoom arrow [<] 1:1 [>]
	zoom_buttons[0].init(button_t::repeatarrowleft, NULL,cursor);
	zoom_buttons[0].add_listener( this );
	add_component( zoom_buttons+0 );
	cursor.x += zoom_buttons[0].get_size().w;

	vzoom_value_label.set_text("1:1");
	vzoom_value_label.set_pos(cursor);
	vzoom_value_label.set_size( scr_size(zoom_label_width,LINESPACE) );
	vzoom_value_label.set_align(gui_label_t::centered);
	vzoom_value_label.set_color(SYSCOL_TEXT);
	add_component( &vzoom_value_label );
	cursor.x += zoom_label_width;

	zoom_buttons[1].init(button_t::repeatarrowright, NULL,cursor);
	zoom_buttons[1].add_listener( this );
	add_component( zoom_buttons+1 );
	cursor.x += zoom_buttons[0].get_size().w + D_H_SPACE;

	//horizontal zoom components
	
	hzoom_label.set_pos(cursor);
	hzoom_label.set_color(SYSCOL_TEXT);
	add_component( &hzoom_label );
	cursor.x += hzoom_label.get_size().w + D_H_SPACE;
	
	zoom_buttons[2].init(button_t::repeatarrowleft, NULL,cursor);
	zoom_buttons[2].add_listener( this );
	add_component( zoom_buttons+2 );
	cursor.x += zoom_buttons[2].get_size().w;
	
	//zoom factor
	hzoom_value_label.set_pos(cursor);
	hzoom_value_label.set_size( scr_size(zoom_label_width,LINESPACE) );
	hzoom_value_label.set_align(gui_label_t::centered);
	hzoom_value_label.set_color(SYSCOL_TEXT);
	add_component( &hzoom_value_label );
	cursor.x += zoom_label_width;
	
	zoom_buttons[3].init(button_t::repeatarrowright, NULL,cursor);
	zoom_buttons[3].add_listener( this );
	add_component( zoom_buttons+3 );
	cursor= scr_coord(0, cursor.y + D_BUTTON_HEIGHT + D_V_SPACE);
	
	//diagram
	diagram.set_pos(cursor);

	scrolly.set_show_scroll_x(true);
	scrolly.set_scroll_discrete_y(false);
	add_component(&scrolly);

		// size is determined using line length and month length(sec)
	uint32 month_length = world()->ticks_to_seconds(world()->ticks_per_world_month);
	//	uint32 line_length = line;
	std::cout <<"month_length="<< month_length << std::endl;
	diagram.set_size(scr_size(month_length/10,100));
	diagram.set_background(COL_WHITE);
	diagram.set_visible(true);
	//	diagram.add_listener(this);
	add_component(&diagram);

	
	draw(scr_coord(0,0), scr_size(D_DEFAULT_WIDTH, D_TITLEBAR_HEIGHT+4+22*(LINESPACE)+D_SCROLLBAR_HEIGHT+2));
	
}



diagram_visualizer_t::~diagram_visualizer_t()
{
	//do nothing
}

void diagram_visualizer_t::set_windowsize(scr_size size)
{
	gui_frame_t::set_windowsize(size);
	scrolly.set_size(get_client_windowsize()-scrolly.get_pos());
	draw(scr_coord(0,0),scr_size(100,100));
	update_lineinfo();

}


diagram_visualizer_t::diagram_visualizer_t():
	gui_frame_t("", NULL),
	scrolly(&cont)
{
	draw(scr_coord(0,0),scr_size(100,100));
	update_lineinfo();
	// just a dummy
}

void diagram_visualizer_t::update_components(){
	const char *name;
	title_buf.clear();
	title_buf.append(translator::translate("Diagram Visualizer: "));
	name = line->get_name();
	title_buf.append(name);



}

bool diagram_visualizer_t::action_triggered(gui_action_creator_t *comp, value_t extra)
{
	
	if(comp==zoom_buttons+0) {
		// zoom out
		vertical_zoom(true);
	}else if(comp == zoom_buttons+1){
		//zoom in
		vertical_zoom(false);
	}else	if(comp==zoom_buttons+2) {
		// zoom out
		horizontal_zoom(true);
	}else if(comp == zoom_buttons+3){
		//zoom out
		horizontal_zoom(false);
	}
	return true;
}

void diagram_visualizer_t::draw(scr_coord pos, scr_size size)
{

	if(line.is_bound()){
		if ((!line->get_schedule()->empty() && !line->get_schedule()->matches(welt, last_schedule))) {
			register_containers();
		}
	}
	int* hzoom=diagram.get_horizontal_zoom_factor();
	char hzoom_text[10];
	sprintf(hzoom_text, "%i:%i", hzoom[0], hzoom[1]);
	hzoom_value_label.set_text(hzoom_text);
	gui_frame_t::draw( pos, size );

	int* vzoom=diagram.get_vertical_zoom_factor();
	char vzoom_text[10];
	sprintf(vzoom_text, "%i:%i", vzoom[0], vzoom[1]);
	vzoom_value_label.set_text(vzoom_text);
	gui_frame_t::draw( pos, size );
	//just a dummy
}
	
void diagram_visualizer_t::update_lineinfo()
{
	diagram.set_visible(true);
}

void diagram_visualizer_t::register_containers()
{
}

void diagram_visualizer_t::horizontal_zoom(bool magnify){
	diagram.horizontal_zoom(magnify);
}

void diagram_visualizer_t::vertical_zoom(bool magnify){
	diagram.vertical_zoom(magnify);
}
